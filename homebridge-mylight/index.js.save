"use strict";

var rpio = require("rpio");

var Service, Characteristic, HomebridgeAPI;

module.exports = function(homebridge) {
  Service = homebridge.hap.Service;
  Characteristic = homebridge.hap.Characteristic;
  HomebridgeAPI = homebridge;
  homebridge.registerAccessory("homebridge-mylight", "MyLight", MyLight);
}

function MyLight(log, config) {
  this.log = log;
  this.name = config.name;

  this._service = new Service.LightSensor(this.name);
  this._service.getCharacteristic(Characteristic.CurrentAmbientLightLevel).setProps({ minValue: -100, maxValue: 3000}).on("get", this.getLight.bind(this));

  this.information = new Service.AccessoryInformation();
  this.information
  .setCharacteristic(Characteristic.Manufacturer, "Marc Julian Schwarz")
  .setCharacteristic(Characteristic.Model, "iBright")
  .setCharacteristic(Characteristic.SerialNumber, "1-2-3")
  .setCharacteristic(Characteristic.FirmwareRevision, "1.0.0");

}


MyLight.prototype.getServices = function() {
  return [this._service, this.information];
}

MyLight.prototype.getLight = function(callback) {
  this.log("Get light");
	var pin = 11;
	var startZeit = Date.now();
	rpio.open(pin, rpio.OUTPUT);
	rpio.write(pin, rpio.LOW);
	rpio.msleep(100);
	rpio.open(pin, rpio.INPUT);
	while(rpio.read(pin) == 0){

	}
	var x = Date.now() - startZeit;
	var y = (x * 10)-1000;
	
	this.log(y);

	callback(null, y);
}
